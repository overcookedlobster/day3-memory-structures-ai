name: GitHub Classroom Workflow

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  checks: write
  actions: read
  contents: read

jobs:
  autograding:
    name: Autograding
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc make valgrind

      - name: Create Build Directory
        run: mkdir -p bin

      - name: Make Test Scripts Executable
        run: chmod +x tests/*.sh

      - name: Build System Check
        id: build-system
        run: |
          echo "Testing build system..."
          if make clean && make all 2>&1; then
            echo "Build system working correctly"
            echo "build_passed=true" >> $GITHUB_OUTPUT
            echo "build_score=10" >> $GITHUB_OUTPUT
          else
            echo "Build system failed"
            echo "build_passed=false" >> $GITHUB_OUTPUT
            echo "build_score=0" >> $GITHUB_OUTPUT
          fi

      - name: Task 1 - Pointer Operations
        id: pointer-tests
        run: |
          echo "Testing pointer operations..."
          compilation_score=0
          functionality_score=0

          # Compilation test
          if gcc -Wall -Wextra -std=c11 -Iinclude src/chip_monitor.c -o bin/chip_monitor -lm 2>&1; then
            echo "âœ“ Pointer operations compilation successful"
            compilation_score=5
          else
            echo "âœ— Pointer operations compilation failed"
          fi

          # Functionality test
          if [ -f "bin/chip_monitor" ] && ./tests/test_pointers.sh 2>&1 | grep -q "POINTER_TESTS_PASSED"; then
            echo "âœ“ Pointer functionality tests passed"
            functionality_score=15
          else
            echo "âœ— Pointer functionality tests failed"
          fi

          total_score=$((compilation_score + functionality_score))
          echo "pointer_compilation_score=$compilation_score" >> $GITHUB_OUTPUT
          echo "pointer_functionality_score=$functionality_score" >> $GITHUB_OUTPUT
          echo "pointer_total_score=$total_score" >> $GITHUB_OUTPUT

      - name: Task 2 - Structure Operations
        id: structure-tests
        run: |
          echo "Testing structure operations..."
          compilation_score=0
          functionality_score=0

          # Compilation test
          if gcc -Wall -Wextra -std=c11 -Iinclude src/chip_monitor.c -o bin/chip_monitor_struct -lm 2>&1; then
            echo "âœ“ Structure operations compilation successful"
            compilation_score=5
          else
            echo "âœ— Structure operations compilation failed"
          fi

          # Functionality test
          if ./tests/test_structures.sh 2>&1 | grep -q "STRUCTURE_TESTS_PASSED"; then
            echo "âœ“ Structure functionality tests passed"
            functionality_score=15
          else
            echo "âœ— Structure functionality tests failed"
          fi

          total_score=$((compilation_score + functionality_score))
          echo "structure_compilation_score=$compilation_score" >> $GITHUB_OUTPUT
          echo "structure_functionality_score=$functionality_score" >> $GITHUB_OUTPUT
          echo "structure_total_score=$total_score" >> $GITHUB_OUTPUT

      - name: Task 3 - Bit Operations
        id: bit-tests
        run: |
          echo "Testing bit operations..."
          compilation_score=0
          functionality_score=0

          # Compilation test
          if gcc -Wall -Wextra -std=c11 -Iinclude src/bit_operations.c -o bin/bit_operations -lm 2>&1; then
            echo "âœ“ Bit operations compilation successful"
            compilation_score=5
          else
            echo "âœ— Bit operations compilation failed"
          fi

          # Functionality test
          if ./tests/test_bit_operations.sh 2>&1 | grep -q "BIT_TESTS_PASSED"; then
            echo "âœ“ Bit operations functionality tests passed"
            functionality_score=15
          else
            echo "âœ— Bit operations functionality tests failed"
          fi

          total_score=$((compilation_score + functionality_score))
          echo "bit_compilation_score=$compilation_score" >> $GITHUB_OUTPUT
          echo "bit_functionality_score=$functionality_score" >> $GITHUB_OUTPUT
          echo "bit_total_score=$total_score" >> $GITHUB_OUTPUT

      - name: Task 4 - Multi-Chip Arrays
        id: multichip-tests
        run: |
          echo "Testing multi-chip arrays..."
          compilation_score=0
          functionality_score=0

          # Compilation test
          if gcc -Wall -Wextra -std=c11 -Iinclude src/multi_chip_test.c -o bin/multi_chip_test -lm 2>&1; then
            echo "âœ“ Multi-chip compilation successful"
            compilation_score=5
          else
            echo "âœ— Multi-chip compilation failed"
          fi

          # Functionality test
          if ./tests/test_multi_chip.sh 2>&1 | grep -q "MULTI_CHIP_TESTS_PASSED"; then
            echo "âœ“ Multi-chip functionality tests passed"
            functionality_score=15
          else
            echo "âœ— Multi-chip functionality tests failed"
          fi

          total_score=$((compilation_score + functionality_score))
          echo "multichip_compilation_score=$compilation_score" >> $GITHUB_OUTPUT
          echo "multichip_functionality_score=$functionality_score" >> $GITHUB_OUTPUT
          echo "multichip_total_score=$total_score" >> $GITHUB_OUTPUT

      - name: Task 5 - AI Integration
        id: ai-tests
        run: |
          echo "Testing AI integration..."
          compilation_score=0
          documentation_score=0

          # Compilation test
          if gcc -Wall -Wextra -std=c11 -Iinclude src/ai_enhanced_validation.c -o bin/ai_validation -lm 2>&1; then
            echo "âœ“ AI integration compilation successful"
            compilation_score=5
          else
            echo "âœ— AI integration compilation failed"
          fi

          # Documentation test
          if ./tests/test_ai_documentation.sh 2>&1 | grep -q "AI_DOCS_FOUND"; then
            echo "âœ“ AI documentation tests passed"
            documentation_score=10
          else
            echo "âœ— AI documentation tests failed"
          fi

          total_score=$((compilation_score + documentation_score))
          echo "ai_compilation_score=$compilation_score" >> $GITHUB_OUTPUT
          echo "ai_documentation_score=$documentation_score" >> $GITHUB_OUTPUT
          echo "ai_total_score=$total_score" >> $GITHUB_OUTPUT

      - name: Quality and Safety Tests
        id: quality-tests
        run: |
          echo "Running quality and safety tests..."
          memory_score=0
          quality_score=0
          integration_score=0
          implementation_score=0

          # Memory safety test
          if make debug && ./tests/test_memory_safety.sh 2>&1 | grep -q "MEMORY_SAFE"; then
            echo "âœ“ Memory safety tests passed"
            memory_score=10
          else
            echo "âœ— Memory safety tests failed"
          fi

          # Code quality test
          if ./tests/test_code_quality.sh 2>&1 | grep -q "QUALITY_CHECKS_PASSED"; then
            echo "âœ“ Code quality tests passed"
            quality_score=10
          else
            echo "âœ— Code quality tests failed"
          fi

          # Integration test
          if make all && ./tests/test_integration.sh 2>&1 | grep -q "INTEGRATION_PASSED"; then
            echo "âœ“ Integration tests passed"
            integration_score=15
          else
            echo "âœ— Integration tests failed"
          fi

          # Implementation test
          if ./tests/test_function_implementation.sh 2>&1 | grep -q "FUNCTIONS_IMPLEMENTED"; then
            echo "âœ“ Function implementation tests passed"
            implementation_score=15
          else
            echo "âœ— Function implementation tests failed"
          fi

          echo "memory_score=$memory_score" >> $GITHUB_OUTPUT
          echo "quality_score=$quality_score" >> $GITHUB_OUTPUT
          echo "integration_score=$integration_score" >> $GITHUB_OUTPUT
          echo "implementation_score=$implementation_score" >> $GITHUB_OUTPUT

      - name: Calculate Final Scores
        run: |
          # Calculate individual category scores
          build_score=${{ steps.build-system.outputs.build_score }}
          pointer_score=${{ steps.pointer-tests.outputs.pointer_total_score }}
          structure_score=${{ steps.structure-tests.outputs.structure_total_score }}
          bit_score=${{ steps.bit-tests.outputs.bit_total_score }}
          multichip_score=${{ steps.multichip-tests.outputs.multichip_total_score }}
          ai_score=${{ steps.ai-tests.outputs.ai_total_score }}
          memory_score=${{ steps.quality-tests.outputs.memory_score }}
          quality_score=${{ steps.quality-tests.outputs.quality_score }}
          integration_score=${{ steps.quality-tests.outputs.integration_score }}
          implementation_score=${{ steps.quality-tests.outputs.implementation_score }}

          # Calculate total
          total_score=$((build_score + pointer_score + structure_score + bit_score + multichip_score + ai_score + memory_score + quality_score + integration_score + implementation_score))

          # Create detailed summary
          echo "## í ¼í¾¯ Autograding Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### í ½í³Š Score Breakdown" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Category | Score | Max Points | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|-------|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| í ½í´§ Build System | $build_score | 10 | $([ $build_score -eq 10 ] && echo "âœ…" || echo "âŒ") |" >> $GITHUB_STEP_SUMMARY
          echo "| í ½í±‰ Pointer Operations | $pointer_score | 20 | $([ $pointer_score -eq 20 ] && echo "âœ…" || echo "âš ï¸") |" >> $GITHUB_STEP_SUMMARY
          echo "| í ¼í¿—ï¸ Structure Operations | $structure_score | 20 | $([ $structure_score -eq 20 ] && echo "âœ…" || echo "âš ï¸") |" >> $GITHUB_STEP_SUMMARY
          echo "| í ½í´¢ Bit Operations | $bit_score | 20 | $([ $bit_score -eq 20 ] && echo "âœ…" || echo "âš ï¸") |" >> $GITHUB_STEP_SUMMARY
          echo "| í ½í¶¥ï¸ Multi-Chip Arrays | $multichip_score | 20 | $([ $multichip_score -eq 20 ] && echo "âœ…" || echo "âš ï¸") |" >> $GITHUB_STEP_SUMMARY
          echo "| í ¾í´– AI Integration | $ai_score | 15 | $([ $ai_score -eq 15 ] && echo "âœ…" || echo "âš ï¸") |" >> $GITHUB_STEP_SUMMARY
          echo "| í ½í»¡ï¸ Memory Safety | $memory_score | 10 | $([ $memory_score -eq 10 ] && echo "âœ…" || echo "âŒ") |" >> $GITHUB_STEP_SUMMARY
          echo "| í ½í³‹ Code Quality | $quality_score | 10 | $([ $quality_score -eq 10 ] && echo "âœ…" || echo "âŒ") |" >> $GITHUB_STEP_SUMMARY
          echo "| í ½í´— Integration | $integration_score | 15 | $([ $integration_score -eq 15 ] && echo "âœ…" || echo "âŒ") |" >> $GITHUB_STEP_SUMMARY
          echo "| âš™ï¸ Implementation | $implementation_score | 15 | $([ $implementation_score -eq 15 ] && echo "âœ…" || echo "âŒ") |" >> $GITHUB_STEP_SUMMARY
          echo "| **í ¼í¿† TOTAL** | **$total_score** | **155** | $([ $total_score -eq 155 ] && echo "í ¼í¾‰" || echo "í ½í³ˆ") |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add detailed breakdown
          echo "### í ½í³ Detailed Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Task Breakdown:" >> $GITHUB_STEP_SUMMARY
          echo "- **Pointer Operations**: Compilation (${{ steps.pointer-tests.outputs.pointer_compilation_score }}/5) + Functionality (${{ steps.pointer-tests.outputs.pointer_functionality_score }}/15)" >> $GITHUB_STEP_SUMMARY
          echo "- **Structure Operations**: Compilation (${{ steps.structure-tests.outputs.structure_compilation_score }}/5) + Functionality (${{ steps.structure-tests.outputs.structure_functionality_score }}/15)" >> $GITHUB_STEP_SUMMARY
          echo "- **Bit Operations**: Compilation (${{ steps.bit-tests.outputs.bit_compilation_score }}/5) + Functionality (${{ steps.bit-tests.outputs.bit_functionality_score }}/15)" >> $GITHUB_STEP_SUMMARY
          echo "- **Multi-Chip Arrays**: Compilation (${{ steps.multichip-tests.outputs.multichip_compilation_score }}/5) + Functionality (${{ steps.multichip-tests.outputs.multichip_functionality_score }}/15)" >> $GITHUB_STEP_SUMMARY
          echo "- **AI Integration**: Compilation (${{ steps.ai-tests.outputs.ai_compilation_score }}/5) + Documentation (${{ steps.ai-tests.outputs.ai_documentation_score }}/10)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add performance indicator
          percentage=$((total_score * 100 / 155))
          if [ $percentage -ge 90 ]; then
            echo "### í ¼í¼Ÿ Excellent Work! ($percentage%)" >> $GITHUB_STEP_SUMMARY
            echo "Outstanding performance across all categories!" >> $GITHUB_STEP_SUMMARY
          elif [ $percentage -ge 80 ]; then
            echo "### í ½í± Great Job! ($percentage%)" >> $GITHUB_STEP_SUMMARY
            echo "Strong performance with room for minor improvements." >> $GITHUB_STEP_SUMMARY
          elif [ $percentage -ge 70 ]; then
            echo "### í ½í³š Good Progress! ($percentage%)" >> $GITHUB_STEP_SUMMARY
            echo "Solid foundation with some areas needing attention." >> $GITHUB_STEP_SUMMARY
          else
            echo "### í ½í²ª Keep Working! ($percentage%)" >> $GITHUB_STEP_SUMMARY
            echo "Focus on the failing tests to improve your score." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Autograding Reporter
        uses: education/autograding@v1
        env:
          BUILD_RESULTS: "${{ steps.build-system.outputs.build_passed }}"
          POINTER_RESULTS: "${{ steps.pointer-tests.outputs.pointer_total_score }}/20"
          STRUCTURE_RESULTS: "${{ steps.structure-tests.outputs.structure_total_score }}/20"
          BIT_RESULTS: "${{ steps.bit-tests.outputs.bit_total_score }}/20"
          MULTICHIP_RESULTS: "${{ steps.multichip-tests.outputs.multichip_total_score }}/20"
          AI_RESULTS: "${{ steps.ai-tests.outputs.ai_total_score }}/15"

